@implements IDisposable
@inject PlayTale.Features.Audiobooks.Services.IAudioService AudioService
@inject PlayTale.Features.Audiobooks.Services.ILibraryService LibraryService
@inject NavigationManager Navigation

@if (AudioService.CurrentState.ChapterId is not null)
{
    <div class="mini-player">
        <button type="button" class="mini-player__cover" @onclick="OpenPlayer" title="Open player">
            @if (!string.IsNullOrWhiteSpace(_coverDataUri))
            {
                <img src="@_coverDataUri" alt="@_title cover" />
            }
            else
            {
                @GetCoverGlyph(_title)
            }
        </button>
        <div class="mini-player__meta" @onclick="OpenPlayer">
            <div class="mini-player__title" title="@_title">@_title</div>
            <div class="mini-player__subtitle" title="@_subtitle">@_subtitle</div>
            <div class="mini-player__progress" aria-hidden="true">
                <span style="@($"width:{_progressPercent:0.##}%;")"></span>
            </div>
        </div>
        <div class="mini-player__controls">
            <button type="button" class="mini-player__button" title="Play or pause" @onclick="TogglePlayAsync">
                @(AudioService.CurrentState.IsPlaying ? "II" : "▶")
            </button>
            <button type="button" class="mini-player__button mini-player__button--ghost" title="Skip forward 30 seconds" @onclick="SkipForwardAsync">
                ⏭
            </button>
        </div>
    </div>
}

@code {
    private string _title = "Now Playing";
    private string _subtitle = "Tap to open player";
    private Guid? _lastBookId;
    private Guid? _lastChapterId;
    private string? _coverDataUri;
    private double _progressPercent;

    [Parameter]
    public string Title { get; set; } = "Now Playing";

    [Parameter]
    public string Subtitle { get; set; } = "Tap to open player";

    protected override void OnInitialized()
    {
        AudioService.PlaybackStateChanged += OnPlaybackStateChanged;
        _ = RefreshMetadataAsync(AudioService.CurrentState);
    }

    private void OnPlaybackStateChanged(object? sender, PlayTale.Features.Audiobooks.Models.PlaybackState e)
    {
        _ = RefreshMetadataAsync(e);
    }

    private async Task RefreshMetadataAsync(PlayTale.Features.Audiobooks.Models.PlaybackState state)
    {
        _progressPercent = state.DurationSeconds > 0
            ? Math.Clamp((state.PositionSeconds / state.DurationSeconds) * 100, 0, 100)
            : 0;

        if (state.BookId is null || state.ChapterId is null)
        {
            _title = Title;
            _subtitle = Subtitle;
            _coverDataUri = null;
            await InvokeAsync(StateHasChanged);
            return;
        }

        if (_lastBookId == state.BookId && _lastChapterId == state.ChapterId)
        {
            await InvokeAsync(StateHasChanged);
            return;
        }

        _lastBookId = state.BookId;
        _lastChapterId = state.ChapterId;

        var book = await LibraryService.GetBookAsync(state.BookId.Value);
        var chapters = await LibraryService.GetChaptersAsync(state.BookId.Value);
        var chapter = chapters.FirstOrDefault(x => x.Id == state.ChapterId.Value);

        _title = string.IsNullOrWhiteSpace(book?.Title) ? Title : book.Title;
        _subtitle = string.IsNullOrWhiteSpace(chapter?.Title) ? Subtitle : chapter.Title;
        _coverDataUri = BuildCoverDataUri(book?.CoverPath);

        await InvokeAsync(StateHasChanged);
    }

    private static string? BuildCoverDataUri(string? coverPath)
    {
        if (string.IsNullOrWhiteSpace(coverPath) || !File.Exists(coverPath))
        {
            return null;
        }

        try
        {
            var bytes = File.ReadAllBytes(coverPath);
            var mimeType = Path.GetExtension(coverPath).Equals(".png", StringComparison.OrdinalIgnoreCase)
                ? "image/png"
                : "image/jpeg";

            return $"data:{mimeType};base64,{Convert.ToBase64String(bytes)}";
        }
        catch
        {
            return null;
        }
    }

    private static string GetCoverGlyph(string title)
    {
        return string.IsNullOrWhiteSpace(title) ? "A" : title.Trim()[0].ToString().ToUpperInvariant();
    }

    private void OpenPlayer()
    {
        var state = AudioService.CurrentState;
        if (state.BookId is null || state.ChapterId is null)
        {
            return;
        }

        Navigation.NavigateTo($"/audiobooks/player/{state.BookId.Value:D}/{state.ChapterId.Value:D}");
    }

    private async Task TogglePlayAsync()
    {
        if (AudioService.CurrentState.IsPlaying)
        {
            await AudioService.PauseAsync();
            return;
        }

        await AudioService.ResumeAsync();
    }

    private async Task SkipForwardAsync()
    {
        await AudioService.SkipByAsync(30);
    }

    public void Dispose()
    {
        AudioService.PlaybackStateChanged -= OnPlaybackStateChanged;
    }
}
