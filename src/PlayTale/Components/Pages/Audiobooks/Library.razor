@page "/"
@page "/audiobooks"
@inject PlayTale.Features.Audiobooks.Services.ILibraryService LibraryService
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Components

<PageTitle>Audiobooks</PageTitle>

<section class="screen">
    <header class="screen__header">
        <h1>Audiobooks</h1>
        <button type="button" class="icon-btn" title="Import audiobook" disabled="@_isImporting" @onclick="ImportAsync">
            @(_isImporting ? "..." : "+")
        </button>
    </header>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <p class="error">@_error</p>
    }

    @if (_books.Count == 0)
    {
        <div class="empty-state">
            <p>No audiobooks yet</p>
            <button type="button" class="primary-btn" disabled="@_isImporting" @onclick="ImportAsync">
                Import Audiobook
            </button>
        </div>
    }
    else
    {
        <div class="book-list">
            @foreach (var book in _books)
            {
                <button type="button" class="book-row" @onclick="() => OpenBook(book.Id)">
                    <div class="book-row__cover">@GetCoverGlyph(book.Title)</div>
                    <div class="book-row__meta">
                        <div class="book-row__title">@book.Title</div>
                        <div class="book-row__subtitle">@GetProgressText(book)</div>
                    </div>
                    <div class="book-row__chevron">â€º</div>
                </button>
            }
        </div>
    }

    <PlayTale.Components.Shared.Audiobooks.MiniPlayer />
</section>

@code {
    private readonly List<PlayTale.Features.Audiobooks.Models.Book> _books = new();
    private bool _isImporting;
    private bool _reimportAttempted;
    private string? _error;

    [Parameter]
    [SupplyParameterFromQuery(Name = "reimport")]
    public bool? Reimport { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadBooksAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Reimport == true && !_reimportAttempted)
        {
            _reimportAttempted = true;
            await ImportAsync();
            Navigation.NavigateTo("/audiobooks", replace: true);
        }
    }

    private async Task LoadBooksAsync()
    {
        _error = null;
        _books.Clear();
        var books = await LibraryService.GetLibraryAsync();
        _books.AddRange(books);
    }

    private async Task ImportAsync()
    {
        if (_isImporting)
        {
            return;
        }

        try
        {
            _isImporting = true;
            _error = null;
            var book = await LibraryService.ImportAsync();
            await LoadBooksAsync();
            OpenBook(book.Id);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isImporting = false;
        }
    }

    private void OpenBook(Guid bookId)
    {
        Navigation.NavigateTo($"/audiobooks/book/{bookId:D}");
    }

    private static string GetProgressText(PlayTale.Features.Audiobooks.Models.Book book)
    {
        if (book.LastPositionSeconds <= 0)
        {
            return "Not started";
        }

        return $"Chapter {book.LastChapterIndex + 1} at {FormatTime(book.LastPositionSeconds)}";
    }

    private static string FormatTime(double seconds)
    {
        var ts = TimeSpan.FromSeconds(Math.Max(0, seconds));
        return ts.TotalHours >= 1 ? ts.ToString(@"hh\:mm\:ss") : ts.ToString(@"mm\:ss");
    }

    private static string GetCoverGlyph(string title)
    {
        return string.IsNullOrWhiteSpace(title) ? "A" : title.Trim()[0].ToString().ToUpperInvariant();
    }
}
